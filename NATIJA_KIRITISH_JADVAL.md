# âœ… Natija Kiritishda Test Parametrlari Jadvali

## ğŸ¯ Yangi Funksiya

Endi natija kiritishda xizmat qo'shishda yaratilgan test parametrlari jadvali avtomatik ko'rsatiladi!

---

## ğŸ“‹ Qanday Ishlaydi?

### 1. Xizmat Qo'shishda Test Parametrlarini Kiritish
```
1. Laboratoriya â†’ Tahlillar katalogi
2. "Xizmat qo'shish" tugmasini bosing
3. Asosiy ma'lumotlarni kiriting:
   - Xizmat nomi: "Umumiy qon tahlili"
   - Narxi: 50000
4. "Natijalar jadvali" bo'limida parametrlarni qo'shing:
   - Katak qo'shish tugmasini bosing
   - Parametr nomi: "Gemoglobin"
   - Birlik: "g/L"
   - Normal diapazon: "120-160"
   - Tavsif: "Qon tarkibidagi gemoglobin miqdori"
5. Yana parametrlar qo'shing (masalan: Eritrotsitlar, Leykotsitlar, va h.k.)
6. "Qo'shish" tugmasini bosing
```

### 2. Buyurtma Berish
```
1. Laboratoriya â†’ Buyurtmalar
2. "Buyurtma berish" tugmasini bosing
3. Bemorni tanlang
4. Tahlilni tanlang (test parametrlari bilan yaratilgan xizmat)
5. Buyurtmani yarating
```

### 3. Natija Kiritish
```
1. Buyurtmalar ro'yxatida "Natija kiritish" tugmasini bosing
2. Modal oynada avtomatik ravishda test parametrlari jadvali ko'rsatiladi
3. Har bir parametr uchun natijani kiriting:
   - Gemoglobin: 145 g/L
   - Eritrotsitlar: 4.5 x10^12/L
   - Leykotsitlar: 7.2 x10^9/L
4. Normal diapazon avtomatik ko'rsatiladi
5. Laborant izohi qo'shing (ixtiyoriy)
6. "Natijani yuborish" tugmasini bosing
```

---

## ğŸ¨ Qanday Ko'rinadi?

### Natija Kiritish Modal (Test Parametrlari Bilan):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Natija kiritish                            [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€ Bemor Ma'lumotlari â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Mironshox Raxmatilloyev                  â”‚  â”‚
â”‚  â”‚ Umumiy qon tahlili                       â”‚  â”‚
â”‚  â”‚ Buyurtma: LAB000123                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚  Natijalar jadvali                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Gemoglobin                              â”‚   â”‚
â”‚  â”‚ Normal: 120-160 g/L                     â”‚   â”‚
â”‚  â”‚ Qon tarkibidagi gemoglobin miqdori      â”‚   â”‚
â”‚  â”‚                                         â”‚   â”‚
â”‚  â”‚ Natija *: [145_______] Birlik: [g/L__] â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Eritrotsitlar                           â”‚   â”‚
â”‚  â”‚ Normal: 4.0-5.5 x10^12/L                â”‚   â”‚
â”‚  â”‚                                         â”‚   â”‚
â”‚  â”‚ Natija *: [4.5_______] Birlik: [x10^12/L] â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Leykotsitlar                            â”‚   â”‚
â”‚  â”‚ Normal: 4.0-9.0 x10^9/L                 â”‚   â”‚
â”‚  â”‚                                         â”‚   â”‚
â”‚  â”‚ Natija *: [7.2_______] Birlik: [x10^9/L]â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                 â”‚
â”‚  Izohlar                                        â”‚
â”‚  [Barcha ko'rsatkichlar normal___________]      â”‚
â”‚                                                 â”‚
â”‚  [Bekor qilish]  [Natijani yuborish]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Natija Kiritish Modal (Test Parametrlari Bo'lmasa):
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Natija kiritish                            [X] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€ Bemor Ma'lumotlari â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Mironshox Raxmatilloyev                  â”‚  â”‚
â”‚  â”‚ Biokimyoviy tahlil                       â”‚  â”‚
â”‚  â”‚ Buyurtma: LAB000124                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                 â”‚
â”‚  Sonli natija                                   â”‚
â”‚  [145.5_____________] [mg/dL___]                â”‚
â”‚                                                 â”‚
â”‚  Matnli natija                                  â”‚
â”‚  [Barcha ko'rsatkichlar normal diapazon_____]   â”‚
â”‚  [ichida. Patologiya aniqlanmadi.___________]   â”‚
â”‚                                                 â”‚
â”‚  Laborant izohi                                 â”‚
â”‚  [Takroriy tekshiruv tavsiya etilmaydi______]   â”‚
â”‚                                                 â”‚
â”‚  [Bekor qilish]  [Natijani yuborish]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ Texnik Tafsilotlar

### Frontend - Laboratory.jsx

#### ResultModal Component
```javascript
// Test parametrlarini yuklash
useEffect(() => {
  const loadTestDetails = async () => {
    if (order?.test_id) {
      const response = await laboratoryService.getTestById(order.test_id);
      setTestDetails(response.data);
      
      // Initialize parameter results
      if (response.data.test_parameters?.length > 0) {
        setParameterResults(
          response.data.test_parameters.map(param => ({
            parameter_name: param.name,
            value: '',
            unit: param.unit || '',
            normal_range: param.normal_range || '',
            description: param.description || ''
          }))
        );
      }
    }
  };
  
  if (isOpen) {
    loadTestDetails();
  }
}, [isOpen, order]);

// Natijani yuborish
const handleSubmit = async (e) => {
  e.preventDefault();
  
  if (hasParameterResults) {
    await laboratoryService.submitResults(order.id, {
      test_results: parameterResults.filter(p => p.value),
      notes: formData.technician_notes
    });
  }
};
```

### Backend - laboratory.routes.js

#### Create Order Endpoint
```javascript
// test_id ni saqlash
const order = new LabOrder({
  patient_id,
  doctor_id: doctor_id || req.user.id,
  test_id: test._id,  // â† Test ID saqlanadi
  test_type: test.category,
  test_name: test.name,
  // ...
});
```

#### Get Orders Endpoint
```javascript
// test_id ni qaytarish
data: orders.map(o => ({
  id: o._id,
  test_id: o.test_id,  // â† Frontend uchun
  test_name: o.test_name,
  // ...
}))
```

#### Submit Results Endpoint
```javascript
router.post('/orders/:id/results', async (req, res) => {
  const { test_results, notes } = req.body;
  
  // test_results array format:
  // [{
  //   parameter_name: 'Gemoglobin',
  //   value: '145',
  //   unit: 'g/L',
  //   normal_range: '120-160',
  //   is_normal: true
  // }]
  
  await LabOrder.findByIdAndUpdate(req.params.id, {
    results: test_results,
    notes: notes || '',
    status: 'completed',
    completed_at: new Date()
  });
});
```

### Backend - LabOrder.js Model
```javascript
const labOrderSchema = new mongoose.Schema({
  // ...
  test_id: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'LabTest'  // â† Test ID reference
  },
  results: [{
    parameter_name: String,
    value: String,
    unit: String,
    normal_range: String,
    is_normal: Boolean
  }],
  // ...
});
```

### Frontend - laboratoryService.js
```javascript
// Bitta testni olish
getTestById: async (id) => {
  const response = await api.get(`/laboratory/tests/${id}`);
  return response.data;
},

// Natijalarni yuborish
submitResults: async (orderId, results) => {
  const response = await api.post(
    `/laboratory/orders/${orderId}/results`, 
    results
  );
  return response.data;
}
```

---

## ğŸ”„ Ma'lumot Oqimi

```
1. Xizmat Qo'shish
   â†“
   LabTest yaratiladi (test_parameters bilan)
   â†“
2. Buyurtma Berish
   â†“
   LabOrder yaratiladi (test_id saqlanadi)
   â†“
3. Natija Kiritish Modal Ochiladi
   â†“
   test_id orqali LabTest yuklanadi
   â†“
   test_parameters dan parameterResults yaratiladi
   â†“
4. Laborant Natijalarni Kiritadi
   â†“
   Har bir parametr uchun value kiritiladi
   â†“
5. Natijani Yuborish
   â†“
   test_results array backend'ga yuboriladi
   â†“
   LabOrder.results yangilanadi
   â†“
   Status 'completed' ga o'zgaradi
```

---

## âœ… Afzalliklar

### 1. Strukturalashgan Natijalar
- Har bir parametr alohida
- Normal diapazon ko'rsatiladi
- Birliklar avtomatik to'ldiriladi

### 2. Xatolarni Kamaytirish
- Parametr nomlari oldindan belgilangan
- Birliklar standartlashtirilgan
- Normal diapazon har doim ko'rinadi

### 3. Tezkor Kiritish
- Faqat qiymatlarni kiritish kerak
- Parametr nomlari va birliklar avtomatik
- Tab tugmasi bilan keyingi parametrga o'tish

### 4. Moslashuvchanlik
- Test parametrlari bo'lsa - jadval ko'rsatiladi
- Test parametrlari bo'lmasa - oddiy forma ko'rsatiladi
- Ikkala usul ham qo'llab-quvvatlanadi

---

## ğŸ› Agar Jadval Ko'rinmasa?

### 1. Test Parametrlarini Tekshiring
```bash
1. Laboratoriya â†’ Tahlillar katalogi
2. Xizmatni tahrirlang
3. "Natijalar jadvali" bo'limida parametrlar bormi?
4. Agar yo'q bo'lsa, parametrlar qo'shing
```

### 2. Buyurtmani Qayta Yarating
```bash
1. Eski buyurtmada test_id bo'lmasligi mumkin
2. Yangi buyurtma yarating
3. Yangi buyurtmada natija kiritishni sinab ko'ring
```

### 3. Browser Console'ni Tekshiring
```bash
F12 â†’ Console
Quyidagi log'lar ko'rinishi kerak:
- Loading test details...
- Test details loaded: {...}
- test_parameters: [...]
```

### 4. Backend'ni Restart Qiling
```bash
cd backend
npm start
```

---

## ğŸ“Š Test Qilish

### 1. Test Parametrlari Bilan Xizmat Yaratish
```bash
âœ… Xizmat nomi: "Umumiy qon tahlili"
âœ… Narxi: 50000
âœ… Parametr 1: Gemoglobin, g/L, 120-160
âœ… Parametr 2: Eritrotsitlar, x10^12/L, 4.0-5.5
âœ… Parametr 3: Leykotsitlar, x10^9/L, 4.0-9.0
```

### 2. Buyurtma Berish
```bash
âœ… Bemor: Mironshox Raxmatilloyev
âœ… Tahlil: Umumiy qon tahlili
âœ… Buyurtma yaratildi: LAB000123
```

### 3. Natija Kiritish
```bash
âœ… "Natija kiritish" tugmasini bosing
âœ… Modal ochiladi
âœ… 3 ta parametr ko'rinadi âœ“
âœ… Har birida normal diapazon ko'rinadi âœ“
âœ… Natijalarni kiriting:
   - Gemoglobin: 145
   - Eritrotsitlar: 4.5
   - Leykotsitlar: 7.2
âœ… "Natijani yuborish" tugmasini bosing
âœ… Natija saqlandi âœ“
```

---

## ğŸ‰ NATIJA

Endi:
- âœ… Xizmat qo'shishda test parametrlarini kiritish mumkin
- âœ… Natija kiritishda parametrlar jadvali avtomatik ko'rsatiladi
- âœ… Normal diapazon va birliklar avtomatik to'ldiriladi
- âœ… Strukturalashgan natijalar saqlanadi
- âœ… Test parametrlari bo'lmasa oddiy forma ko'rsatiladi

**Hammasi tayyor va ishlayapti!** ğŸš€

---

## ğŸ“ Keyingi Qadamlar

1. âœ… Test parametrlari jadvali - TAYYOR
2. ğŸ”„ Natijalarni chop etish
3. ğŸ”„ Telegram botga natijalarni yuborish
4. ğŸ”„ Bemor profilida natijalarni ko'rsatish
5. ğŸ”„ Normal/Anormal ko'rsatkichlarni rangli belgilash
