import jwt from 'jsonwebtoken';
import { query } from '../config/database.js';
import { AppError } from '../utils/errors.js';

export const authenticate = async (req, res, next) => {
  try {
    const token = req.headers.authorization?.replace('Bearer ', '');
    
    if (!token) {
      throw new AppError('Authentication required', 401);
    }
    
    const decoded = jwt.verify(token, process.env.JWT_SECRET);
    
    console.log('=== AUTHENTICATE MIDDLEWARE ===');
    console.log('Token type:', decoded.type);
    console.log('User ID:', decoded.userId);
    
    // Agar bemor token'i bo'lsa
    if (decoded.type === 'patient') {
      try {
        const result = await query(
          `SELECT id, patient_number, first_name, last_name, phone, username
           FROM patients 
           WHERE id = $1 AND is_active = true`,
          [decoded.userId]
        );
        
        if (result.rows.length === 0) {
          throw new AppError('Patient not found or inactive', 401);
        }
        
        const patient = result.rows[0];
        req.user = {
          ...patient,
          patient_id: patient.id,
          role_name: 'Bemor',
          type: 'patient'
        };
        
        console.log('✅ Patient authenticated:', patient.patient_number);
        return next();
      } catch (dbError) {
        if (dbError.message.includes('Database not available')) {
          // Database offline - use token data only
          req.user = {
            id: decoded.userId,
            patient_id: decoded.userId,
            patient_number: decoded.patientNumber || 'OFFLINE',
            first_name: decoded.firstName || 'Offline',
            last_name: decoded.lastName || 'User',
            role_name: 'Bemor',
            type: 'patient',
            offline: true
          };
          console.log('⚠️  Patient authenticated (offline mode)');
          return next();
        }
        throw dbError;
      }
    }
    
    // Aks holda staff/admin token'i
    try {
      const result = await query(
        `SELECT u.*, r.name as role_name 
         FROM users u 
         LEFT JOIN roles r ON u.role_id = r.id 
         WHERE u.id = $1 AND u.is_active = true`,
        [decoded.userId]
      );
      
      if (result.rows.length === 0) {
        throw new AppError('User not found or inactive', 401);
      }
      
      const user = result.rows[0];
      
      // Get staff profile if exists
      const staffResult = await query(
        'SELECT * FROM staff_profiles WHERE user_id = $1',
        [user.id]
      );
      
      // Add staffProfile to user object
      if (staffResult.rows.length > 0) {
        user.staffProfile = staffResult.rows[0];
      }
      
      req.user = user;
      console.log('✅ Staff authenticated:', user.username);
      next();
    } catch (dbError) {
      if (dbError.message.includes('Database not available')) {
        // Database offline - use token data only
        req.user = {
          id: decoded.userId,
          username: decoded.username || 'offline_user',
          role_name: decoded.roleName || 'Admin',
          role_id: decoded.roleId || 1,
          offline: true
        };
        console.log('⚠️  Staff authenticated (offline mode)');
        next();
      } else {
        throw dbError;
      }
    }
  } catch (error) {
    if (error.name === 'JsonWebTokenError') {
      next(new AppError('Invalid token', 401));
    } else if (error.name === 'TokenExpiredError') {
      next(new AppError('Token expired', 401));
    } else {
      next(error);
    }
  }
};

export const authorize = (...allowedRoles) => {
  return (req, res, next) => {
    if (!req.user) {
      console.log('❌ AUTHORIZE: No user in request');
      return next(new AppError('Authentication required', 401));
    }
    
    console.log('=== AUTHORIZE MIDDLEWARE ===');
    console.log('User:', req.user.username || req.user.patient_number);
    console.log('User role:', req.user.role_name);
    console.log('Allowed roles:', allowedRoles);
    
    // Role name mapping - support both old and new role names
    const roleMapping = {
      'admin': ['Admin', 'Administrator', 'admin'],  // Database'dagi 'admin' ham qo'shildi
      'Admin': ['Admin', 'Administrator', 'admin'],
      'Administrator': ['Admin', 'Administrator', 'admin'],
      'Manager': ['Manager', 'Menejer'],
      'Menejer': ['Manager', 'Menejer'],
      'doctor': ['Doctor', 'Shifokor', 'doctor'],
      'Doctor': ['Doctor', 'Shifokor', 'doctor'],
      'Shifokor': ['Doctor', 'Shifokor', 'doctor'],
      'nurse': ['Nurse', 'Hamshira', 'nurse'],
      'Nurse': ['Nurse', 'Hamshira', 'nurse'],
      'Hamshira': ['Nurse', 'Hamshira', 'nurse'],
      'receptionist': ['Reception', 'Qabulxona', 'Registrator', 'receptionist'],
      'Reception': ['Reception', 'Qabulxona', 'Registrator', 'receptionist'],
      'Qabulxona': ['Reception', 'Qabulxona', 'Registrator', 'receptionist'],
      'Registrator': ['Reception', 'Qabulxona', 'Registrator', 'receptionist'],
      'cashier': ['Cashier', 'Kassa', 'cashier'],
      'Cashier': ['Cashier', 'Kassa', 'cashier'],
      'Kassa': ['Cashier', 'Kassa', 'cashier'],
      'laborant': ['Lab', 'Laborant', 'laborant'],
      'Lab': ['Lab', 'Laborant', 'laborant'],
      'Laborant': ['Lab', 'Laborant', 'laborant'],
      'sanitar': ['Cleaner', 'Tozalovchi', 'sanitar'],
      'Cleaner': ['Cleaner', 'Tozalovchi', 'sanitar'],
      'Tozalovchi': ['Cleaner', 'Tozalovchi', 'sanitar'],
      'pharmacist': ['Pharmacy', 'Dorixona', 'pharmacist'],
      'Pharmacy': ['Pharmacy', 'Dorixona', 'pharmacist'],
      'Dorixona': ['Pharmacy', 'Dorixona', 'pharmacist'],
      'patient': ['Bemor', 'Patient', 'patient'],
      'Bemor': ['Bemor', 'Patient', 'patient'],
      'Patient': ['Bemor', 'Patient', 'patient']
    };
    
    // Get user's actual role
    const userRole = req.user.role_name;
    
    // Check if user's role matches any of the allowed roles (considering aliases)
    const hasPermission = allowedRoles.some(allowedRole => {
      const allowedAliases = roleMapping[allowedRole] || [allowedRole];
      const userAliases = roleMapping[userRole] || [userRole];
      
      // Check if any user alias matches any allowed alias
      return userAliases.some(userAlias => allowedAliases.includes(userAlias));
    });
    
    console.log('Has permission:', hasPermission);
    
    if (!hasPermission) {
      console.log('❌ AUTHORIZE: Permission denied');
      return next(new AppError('Insufficient permissions', 403));
    }
    
    console.log('✅ AUTHORIZE: Permission granted');
    next();
  };
};

export const checkPermission = (resource, action) => {
  return async (req, res, next) => {
    try {
      if (!req.user) {
        throw new AppError('Authentication required', 401);
      }
      
      const result = await query(
        `SELECT COUNT(*) as count
         FROM role_permissions rp
         JOIN permissions p ON rp.permission_id = p.id
         WHERE rp.role_id = $1 
         AND p.resource = $2 
         AND p.action = $3`,
        [req.user.role_id, resource, action]
      );
      
      if (parseInt(result.rows[0].count) === 0) {
        throw new AppError('Insufficient permissions', 403);
      }
      
      next();
    } catch (error) {
      next(error);
    }
  };
};
